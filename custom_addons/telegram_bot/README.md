# Telegram Bot Integration для Odoo 17

Модуль для интеграции с Telegram ботом, позволяющий клиентам получать уведомления об изменении статуса заказов и общаться с операторами.

## Возможности

- ✅ Идентификация клиентов через Telegram
- ✅ Автоматические уведомления об изменении статуса заказа
- ✅ Чат с оператором
- ✅ История сообщений
- ✅ Команды бота (/start, /orders, /help)

## Установка

1. Установите зависимость `requests`:
```bash
pip install requests
```

2. Установите модуль в Odoo через Apps или командой:
```bash
./odoo-bin -c odoo.conf -u telegram_bot
```

## Настройка

### 1. Создание бота в Telegram

1. Откройте Telegram и найдите [@BotFather](https://t.me/BotFather)
2. Отправьте команду `/newbot`
3. Следуйте инструкциям для создания бота
4. Сохраните полученный **Bot Token**

### 2. Настройка в Odoo

1. Перейдите в **Telegram → Настройки → Конфигурация бота**
2. Заполните поля:
   - **Имя бота**: любое имя для идентификации
   - **Bot Token**: токен от BotFather
   - **Webhook Secret**: придумайте секретный ключ (любая строка)
   - **Операторы**: выберите пользователей, которые могут отвечать клиентам
3. Нажмите **"Установить Webhook"**
4. Активируйте бота (галочка "Активен")

### 3. Идентификация клиента

#### Вариант 1: Через Odoo (для менеджера)

1. Откройте карточку клиента (Партнер)
2. Перейдите в **Telegram → Telegram пользователи**
3. Создайте нового Telegram пользователя:
   - Введите Telegram ID клиента (можно узнать через бота @userinfobot)
   - Выберите партнера
   - Система автоматически сгенерирует код верификации
4. Нажмите **"Отправить код"** - код будет отправлен клиенту в Telegram
5. Клиент вводит код в боте, и происходит автоматическая верификация

#### Вариант 2: Через бота (для клиента)

1. Клиент запускает бота командой `/start`
2. Бот автоматически создает запись и отправляет код верификации
3. Менеджер в Odoo находит нового пользователя и привязывает его к партнеру
4. Клиент вводит код в боте для завершения верификации

## Использование

### Для клиента

После верификации клиент может:

- Получать автоматические уведомления при изменении статуса заказа
- Использовать команды:
  - `/start` - начать работу
  - `/orders` - список заказов
  - `/help` - справка
- Писать сообщения оператору

### Для оператора

1. Перейдите в **Telegram → Сообщения**
2. Просматривайте входящие сообщения от клиентов
3. Нажмите **"Ответить"** на сообщение
4. Введите ответ и отправьте

### Уведомления о статусе заказа

При изменении статуса заказа (`state`) клиент автоматически получает уведомление в Telegram с информацией:
- Номер заказа
- Новый статус
- Дата изменения
- Сумма заказа

## Структура модуля

```
telegram_bot/
├── models/
│   ├── telegram_bot_config.py    # Конфигурация бота
│   ├── telegram_user.py          # Telegram пользователи
│   ├── telegram_message.py       # Сообщения
│   ├── res_partner.py            # Расширение партнеров
│   └── sale_order.py             # Расширение заказов
├── controllers/
│   └── telegram_webhook.py       # Обработка webhook
├── views/                        # Представления
├── security/                     # Права доступа
└── data/                        # Данные по умолчанию
```

## Технические детали

### Webhook

Модуль использует webhook для получения сообщений от Telegram. URL webhook:
```
https://your-odoo-domain.com/telegram/webhook/{webhook_secret}
```

**Важно:** Odoo должен быть доступен из интернета для работы webhook.

### Модели

- `telegram.bot.config` - конфигурация бота
- `telegram.user` - связь партнера с Telegram пользователем
- `telegram.message` - история сообщений

### Безопасность

- Webhook защищен секретным ключом (`webhook_secret`)
- Только верифицированные пользователи получают уведомления
- Операторы назначаются администратором

## Типичные проблемы

### Webhook не работает

1. Проверьте, что Odoo доступен из интернета
2. Проверьте правильность Bot Token
3. Убедитесь, что webhook установлен (кнопка "Установить Webhook")

### Клиент не получает уведомления

1. Проверьте, что клиент верифицирован (`is_verified = True`)
2. Проверьте, что бот активен
3. Проверьте логи Odoo на наличие ошибок

### Ошибка отправки сообщения

1. Проверьте Bot Token
2. Проверьте Chat ID пользователя
3. Убедитесь, что клиент не заблокировал бота

## Разработка

Модуль разработан для Odoo 17 Community/Enterprise.

### Зависимости

- `requests` - для работы с Telegram Bot API
- `base`, `sale`, `mail` - стандартные модули Odoo

### API Telegram

Модуль использует официальный Telegram Bot API:
- `sendMessage` - отправка сообщений
- `setWebhook` - установка webhook
- `deleteWebhook` - удаление webhook

## Лицензия

LGPL-3

